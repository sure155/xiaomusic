version: '3.8'

services:
  xiaomusic:
    # 构建设置
    build:
      context: .
      dockerfile: Dockerfile.optimized
      args:
        PYTHON_VERSION: "3.12"

    # 镜像设置
    image: sure155/xiaomusic:latest
    container_name: xiaomusic
    restart: unless-stopped

    # 环境变量
    environment:
      - TZ=Asia/Shanghai
      - PYTHONUNBUFFERED=1
      - PYTHONIOENCODING=utf-8
      # 性能优化相关
      - DEFAULT_WORKERS=4
      - MAX_CONNECTIONS=100
      - CACHE_TTL=3600

    # 端口映射
    ports:
      - "58090:8090"

    # 卷映射
    volumes:
      - /volume1/music/conf:/app/conf
      - /volume1/music/歌曲:/app/music
      - /volume1/music/cache:/app/cache
      - /volume1/music/js_plugins:/app/conf/js_plugins

    # 性能优化配置
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M

    # 健康检查
    healthcheck:
      test: ["CMD", "python3", "-c", "import requests; requests.get('http://localhost:8090/')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # 网络设置
    networks:
      - xiaomusic-net

  # 缓存服务（可选，用于进一步加速）
  redis:
    image: redis:alpine
    container_name: xiaomusic-redis
    restart: unless-stopped
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
    networks:
      - xiaomusic-net

networks:
  xiaomusic-net:
    driver: bridge

volumes:
  redis-data:
